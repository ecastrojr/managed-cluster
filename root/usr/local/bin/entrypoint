#!/bin/bash

export ENTRYPOINT=$0
export PATH="~/bin/:$PATH"

source /etc/profile.d/getup.sh

run_as_user "$@"

if ! [ -d "${KUBECONFIG%/*}" ]; then
    mkdir -p "${KUBECONFIG%/*}"
fi

if [ -n "$GH_TOKEN" ]; then
    gh auth login --with-token <<<$GH_TOKEN
fi

if [ -r $HOME/.gitconfig.host ] && ! [ -e $HOME/.gitconfig ]; then
    cp -f $HOME/.gitconfig.host $HOME/.gitconfig
fi

if [ "$type" == standalone ] || [ -z "$type" ]; then
    info Entering standalone mode
    export customer=${customer:-standalone}
    export type=${type:-standalone}
    export name=${name:-standalone}

    for env in $REPODIR/templates/*/provider.env; do
        #info Sourcing $env
        source_env $env
    done
fi

if [ -e $WORKDIR/main.tf ] && ! [ -r "$TF_VARS_FILE" ]; then
    debug Terraform variables file not found: $TF_VARS_FILE
    ask_execute_command /usr/local/bin/terraform-setup
fi

exec "$@"
