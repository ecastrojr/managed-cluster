#!/bin/bash

export PATH="~/bin/:$PATH"

source /etc/profile.d/getup.sh

if [ -e $WORKDIR/cluster.conf ]; then
    source_env $WORKDIR/cluster.conf
fi

if [ -e $WORKDIR/provider.env ]; then
    source_env $WORKDIR/provider.env
fi

if ! [ -d "${KUBECONFIG%/*}" ]; then
    mkdir -p "${KUBECONFIG%/*}"
fi

if [ -n "$GH_TOKEN" ]; then
    gh auth login --with-token <<<$GH_TOKEN
fi

if [ -r $HOME/.gitconfig.host ]; then
    cp -f $HOME/.gitconfig.host $HOME/.gitconfig
fi

if [ "$type" == standalone ] || [ -z "$type" ]; then
    info Entering standalone mode
    export customer=${customer:-standalone}
    export type=${type:-standalone}
    export name=${name:-standalone}

    for env in $REPODIR/templates/*/provider.env; do
        #info Sourcing $env
        source_env $env
    done

    exec "$@"
    warn Never reached...
    exit 1
fi

if ! [ -r "$TF_VARS_FILE" ]; then
    debug Terraform variables file not found: $TF_VARS_FILE
    ask_execute_command /usr/local/bin/terraform-setup
fi

exec "$@"
